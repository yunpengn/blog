<!DOCTYPE html><html class="theme-next gemini use-motion" lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><link rel="stylesheet" href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.7.0"><link rel="stylesheet" href="/blog/css/main.css?v=7.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/blog/images/favicon/apple-touch-icon.png?v=7.2.0"><link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon/favicon-32x32.png?v=7.2.0"><link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon/favicon-16x16.png?v=7.2.0"><link rel="mask-icon" href="/blog/images/favicon/safari_pinned_tab.svg?v=7.2.0" color="#222"><meta name="msapplication-config" content="/blog/images/favicon/browserconfig.xml"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/blog/",scheme:"Gemini",version:"7.2.0",sidebar:{position:"left",display:"post",offset:12,onmobile:!1},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},copycode:{enable:!0,show_result:!1,style:null},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},translation:{copy_button:"Copy",copy_success:"Copied",copy_failure:"Copy failed"}}</script><meta name="description" content="In this post, I will discuss a few common partition techniques in distributed cache. Especially, I will elaborate on my understanding on the use of Redis Cluster.Please understand that at the time of"><meta name="keywords" content="Niu,Yunpeng,NUS,CS,Software,Developer"><meta property="og:type" content="article"><meta property="og:title" content="Redis Cluster &amp; Common Partition Techniques in Distributed Cache"><meta property="og:url" content="https://yunpengn.github.io/blog/2018/07/27/redis-cluster-partition/index.html"><meta property="og:site_name" content="Yunpeng&#39;s Blog"><meta property="og:description" content="In this post, I will discuss a few common partition techniques in distributed cache. Especially, I will elaborate on my understanding on the use of Redis Cluster.Please understand that at the time of"><meta property="og:locale" content="en"><meta property="og:updated_time" content="2019-07-13T09:42:23.413Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Redis Cluster &amp; Common Partition Techniques in Distributed Cache"><meta name="twitter:description" content="In this post, I will discuss a few common partition techniques in distributed cache. Especially, I will elaborate on my understanding on the use of Redis Cluster.Please understand that at the time of"><link rel="alternate" href="/blog/atom.xml" title="Yunpeng's Blog" type="application/atom+xml"><link rel="canonical" href="https://yunpengn.github.io/blog/2018/07/27/redis-cluster-partition/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>Redis Cluster & Common Partition Techniques in Distributed Cache | Yunpeng's Blog</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-92228484-1"></script><script>var host=window.location.hostname;if("localhost"!==host){function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-92228484-1")}</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/blog/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Yunpeng's Blog</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Life, coding and everything</p></div><div class="site-nav-toggle"><button aria-label="Toggle navigation bar"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li><li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://yunpengn.github.io/blog/blog/2018/07/27/redis-cluster-partition/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Niu Yunpeng"><meta itemprop="description" content="The world never stops for you."><meta itemprop="image" content="/blog/images/avatar_cropped.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Yunpeng's Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Redis Cluster & Common Partition Techniques in Distributed Cache</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-07-27 13:09:53" itemprop="dateCreated datePublished" datetime="2018-07-27T13:09:53+08:00">2018-07-27</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2019-07-13 17:42:23" itemprop="dateModified" datetime="2019-07-13T17:42:23+08:00">2019-07-13</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/blog/categories/Technical/" itemprop="url" rel="index"><span itemprop="name">Technical</span></a></span> , <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/blog/categories/Technical/Database/" itemprop="url" rel="index"><span itemprop="name">Database</span></a></span> , <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/blog/categories/Technical/Database/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><span class="post-meta-item-text">Comments: </span><a href="/blog/2018/07/27/redis-cluster-partition/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/07/27/redis-cluster-partition/" itemprop="commentCount"></span></a></span><br></div></header><div class="post-body" itemprop="articleBody"><p>In this post, I will discuss a few common partition techniques in distributed cache. Especially, I will elaborate on my understanding on the use of <a href="https://redis.io/topics/cluster-tutorial" target="_blank" rel="noopener">Redis Cluster</a>.</p><p>Please understand that at the time of writing, the latest version of Redis is <a href="http://download.redis.io/releases/redis-4.0.10.tar.gz" target="_blank" rel="noopener">4.0.10</a>. Many articles on the same topic have a different idea from this post. This is mainly because, those articles are probably outdated. In particular, they may refer to the Redis Cluster implementation in Redis 3. Redis Cluster has been improved a lot since Redis 4.</p><p><em>(This article was based on part of my project report. You may want to take a look at the full report <a href="https://dl.comp.nus.edu.sg/handle/1900.100/7123" target="_blank" rel="noopener">here</a>. You may need a valid account to gain access to NUS SoC Digital Library.)</em></p><h2 id="Common-Partition-Techniques"><a href="#Common-Partition-Techniques" class="headerlink" title="Common Partition Techniques"></a>Common Partition Techniques</h2><p>Here, we refer to <strong>horizontal partitioning</strong>, which is also known as <strong>data sharding</strong>. Traditionally, there are 3 approaches to achieve data partitioning, namely, server-side partitioning, cluster proxy, and client-side partitioning.</p><a id="more"></a><h3 id="Server-side-partitioning"><a href="#Server-side-partitioning" class="headerlink" title="Server-side partitioning"></a>Server-side partitioning</h3><p>The datastore nodes take full control of the partitioning. In other words, the client does not know how the partitioning is done. Thus, it has to blindly send a request to a random master node. If this node is not the correct node, a redirect must be done. The redirect can be in the form of either:</p><ul><li>Return an error code to the client and tell the IP address &amp; port of the correct node to the client; or</li><li>The incorrect node will become a client and re-send the request to the correct node.</li></ul><p>This approach has a major drawback that the traffic is doubled (because a redirect is triggered with a high possibility).</p><h3 id="Cluster-proxy"><a href="#Cluster-proxy" class="headerlink" title="Cluster proxy"></a>Cluster proxy</h3><p>There is a proxy or some middleware similar in front of all the nodes. All requests will be sent to the proxy first. Then, the proxy will send the requests to the correct node. For instance, <a href="https://github.com/twitter/twemproxy" target="_blank" rel="noopener">Twemproxy</a> developed by <a href="https://twitter.com/" target="_blank" rel="noopener">Twitter</a> and <a href="https://github.com/CodisLabs/codis" target="_blank" rel="noopener">Codis</a> developed by <a href="http://www.wandoujia.com" target="_blank" rel="noopener">Wandoujia</a> uses this approach. A disadvantage is that the proxy itself becomes a single-point-of-failure.</p><h3 id="Client-side-partitioning"><a href="#Client-side-partitioning" class="headerlink" title="Client-side partitioning"></a>Client-side partitioning</h3><p>The clients decide how to partition the data. There is no extra traffic in this way. However, all clients must agree on a certain partitioning scheme. This approach could be error prone (since the partitioning scheme used may have differences).</p><h2 id="Partitioning-in-Redis-Cluster"><a href="#Partitioning-in-Redis-Cluster" class="headerlink" title="Partitioning in Redis Cluster"></a>Partitioning in Redis Cluster</h2><p>Redis uses a ‚Äúhash-slot‚Äù approach, which can be considered as a mix of server-side partitioning and client-side partitioning. It achieves certain advantages over the 3 traditional approaches.</p><p>The whole range of possible hash codes of keys are divided into 16384 slots. These slots are automatically assigned to different master nodes. The client could get the allocation information easily by using ‚ÄúCLUSTER SLOTS‚Äù command (Redis Labs). This command should be done when the client starts. Each time when the client wants to insert a new key, it will pre-compute the <a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check" target="_blank" rel="noopener">CRC16</a> value of the key. Using its CRC16 value, it could easily detect which hash slot this key belongs to, thus knowing which master node this key should go to. In this way, all the clients must follow the partitioning determined by the server.</p><h2 id="Data-Re-sharding"><a href="#Data-Re-sharding" class="headerlink" title="Data Re-sharding"></a>Data Re-sharding</h2><p>In the sections above, we have discussed how data sharding is usually done. However, a common scenario is that, your business will grow (<em>hopefully, the growth is because you have read this article</em> üòÇ). One day, you may find that you need to add more nodes into your distributed cache, the Redis Cluster. Typically, the process of adding new nodes or removing existing nodes is called <strong>data re-sharding</strong>.</p><p>Let‚Äôs say you have 4000 keys in your key-value store (<em>certainly, 4000 is a too small number since this is just a demo</em>). Previously, you have 4 master nodes and each node will approximatley contain 1000 keys. Now, you want to add a new master node. Thus, there will be 5 master nodes in total and each node will have about 800 keys.</p><p>Now, the problem comes. The new node is empty. How should we move some data into the new node? Ideally, we want to remap only <code>K/n</code> keys on average, where <code>K</code> is the total number of keys and <code>n</code> is the number of nodes. This is where <a href="https://en.wikipedia.org/wiki/Consistent_hashing" target="_blank" rel="noopener">consistent hashing</a> comes into play.</p><p>However, the ‚Äúhash-slot‚Äù approach is again different from the traditional <strong>consistent hashing</strong> approach.</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><a href="https://redis.io/topics/cluster-tutorial" target="_blank" rel="noopener">Redis Cluster Tutorial</a></li><li><a href="https://redis.io/topics/cluster-spec" target="_blank" rel="noopener">Redis Cluster Specification</a></li><li><a href="https://redis.io/presentation/Redis_Cluster.pdf" target="_blank" rel="noopener">Redis Cluster Presentation</a></li></ul></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>Niu Yunpeng</li><li class="post-copyright-link"><strong>Post link: </strong><a href="https://yunpengn.github.io/blog/2018/07/27/redis-cluster-partition/" title="Redis Cluster & Common Partition Techniques in Distributed Cache">https://yunpengn.github.io/blog/2018/07/27/redis-cluster-partition/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-ND</a> unless stating additionally.</li></ul></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/blog/2018/04/29/select-web-tech-stack/" rel="next" title="To Select the Correct Technical Stack for Web"><i class="fa fa-chevron-left"></i> To Select the Correct Technical Stack for Web</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/blog/2018/12/22/literature-review-join-reorder/" rel="prev" title="Literature Review on Join Reorderability">Literature Review on Join Reorderability <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">Overview</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/blog/images/avatar_cropped.jpg" alt="Niu Yunpeng"><p class="site-author-name" itemprop="name">Niu Yunpeng</p><div class="site-description motion-element" itemprop="description">The world never stops for you.</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/blog/archives/"><span class="site-state-item-count">11</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/blog/categories/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">categories</span></a></div></nav><div class="feed-link motion-element"><a href="/blog/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/yunpengn" title="GitHub &rarr; https://github.com/yunpengn" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://www.facebook.com/NeilNiuYunpeng" title="Facebook &rarr; https://www.facebook.com/NeilNiuYunpeng" rel="noopener" target="_blank"><i class="fa fa-fw fa-facebook"></i>Facebook</a> </span><span class="links-of-author-item"><a href="https://sg.linkedin.com/in/yunpeng-niu/en" title="LinkedIn &rarr; https://sg.linkedin.com/in/yunpeng-niu/en" rel="noopener" target="_blank"><i class="fa fa-fw fa-linkedin"></i>LinkedIn</a> </span><span class="links-of-author-item"><a href="https://yunpengn.github.io/" title="Website &rarr; https://yunpengn.github.io/"><i class="fa fa-fw fa-globe"></i>Website</a></span></div><div class="cc-license motion-element" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/blog/images/cc-by-nc-nd.svg" alt="Creative Commons"></a></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Common-Partition-Techniques"><span class="nav-number">1.</span> <span class="nav-text">Common Partition Techniques</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Server-side-partitioning"><span class="nav-number">1.1.</span> <span class="nav-text">Server-side partitioning</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cluster-proxy"><span class="nav-number">1.2.</span> <span class="nav-text">Cluster proxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Client-side-partitioning"><span class="nav-number">1.3.</span> <span class="nav-text">Client-side partitioning</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Partitioning-in-Redis-Cluster"><span class="nav-number">2.</span> <span class="nav-text">Partitioning in Redis Cluster</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Data-Re-sharding"><span class="nav-number">3.</span> <span class="nav-text">Data Re-sharding</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">4.</span> <span class="nav-text">References</span></a></li></ol></div></div></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2017 ‚Äì <span itemprop="copyrightYear">2019</span> <span class="with-love" id="animate"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder"><a href="https://yunpengn.github.io/" class="theme-link" rel="author" target="_blank">Niu Yunpeng</a></span></div><div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div><span class="post-meta-divider">|</span><div class="theme-info">Theme ‚Äì <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.2.0</div></div></footer></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/blog/lib/jquery/index.js?v=3.4.1"></script><script src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/blog/js/utils.js?v=7.2.0"></script><script src="/blog/js/motion.js?v=7.2.0"></script><script src="/blog/js/affix.js?v=7.2.0"></script><script src="/blog/js/schemes/pisces.js?v=7.2.0"></script><script src="/blog/js/scrollspy.js?v=7.2.0"></script><script src="/blog/js/post-details.js?v=7.2.0"></script><script src="/blog/js/next-boot.js?v=7.2.0"></script><script>function loadCount(){var d=document,n=d.createElement("script");n.src="https://yunpeng.disqus.com/count.js",n.id="dsq-count-scr",(d.head||d.body).appendChild(n)}window.addEventListener("load",loadCount,!1)</script><script>var disqus_config=function(){this.page.url="https://yunpengn.github.io/blog/2018/07/27/redis-cluster-partition/",this.page.identifier="2018/07/27/redis-cluster-partition/",this.page.title="Redis Cluster & Common Partition Techniques in Distributed Cache"};function loadComments(){var t=document,e=t.createElement("script");e.src="https://yunpeng.disqus.com/embed.js",e.setAttribute("data-timestamp",""+ +new Date),(t.head||t.body).appendChild(e)}window.addEventListener("load",loadComments,!1)</script></body></html>